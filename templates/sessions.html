{% extends "base.html" %}

{% block title %}Sessions - {{ book.title }} - Booklet{% endblock %}

{% block extra_head %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Reading Sessions</h1>
    </div>

    <!-- Week Navigation -->
    <div class="week-navigation">
        <a href="/sessions/{{ book.id }}?week_start={{ prev_week }}&page={{ current_page }}&limit={{ limit }}" class="btn btn-secondary">‚Üê Previous Week</a>
        <span class="week-display">Week of {{ week_start }}</span>
        <a href="/sessions/{{ book.id }}?week_start={{ next_week }}&page={{ current_page }}&limit={{ limit }}" class="btn btn-secondary">Next Week ‚Üí</a>
    </div>

    <!-- Weekly Stats -->
    <div class="weekly-stats">
        <div class="stat-box">
            <h4>Avg Pages/Hour</h4>
            <div class="stat-value">{{ avg_pages_per_hour }}</div>
            <div class="stat-change {% if pace_change > 0 %}positive{% elif pace_change < 0 %}negative{% else %}neutral{% endif %}">
                {% if pace_change > 0 %}
                ‚Üë +{{ pace_change }}
                {% elif pace_change < 0 %}
                ‚Üì {{ pace_change }}
                {% else %}
                = {{ pace_change }}
                {% endif %}
                from last week
            </div>
        </div>

        <div class="stat-box">
            <h4>Total Pages</h4>
            <div class="stat-value">{{ total_pages }}</div>
            <div class="stat-change {% if pages_change > 0 %}positive{% elif pages_change < 0 %}negative{% else %}neutral{% endif %}">
                {% if pages_change > 0 %}
                ‚Üë +{{ pages_change }}
                {% elif pages_change < 0 %}
                ‚Üì {{ pages_change }}
                {% else %}
                = {{ pages_change }}
                {% endif %}
                from last week
            </div>
        </div>

        <div class="stat-box">
            <h4>Reading Days</h4>
            <div class="stat-value">{{ reading_days }}</div>
            <div class="stat-change {% if days_change > 0 %}positive{% elif days_change < 0 %}negative{% else %}neutral{% endif %}">
                {% if days_change > 0 %}
                ‚Üë +{{ days_change }}
                {% elif days_change < 0 %}
                ‚Üì {{ days_change }}
                {% else %}
                = {{ days_change }}
                {% endif %}
                from last week
            </div>
        </div>
    </div>

    <!-- Reading Pace Chart -->
    {% if weekly_sessions %}
    <div class="chart-container">
        <h2>Reading Pace Analysis</h2>
        <div id="paceChart"></div>
    </div>
    {% endif %}

    <!-- All Sessions Table -->
    <div class="sessions-table-section">
        <h2>All Sessions ({{ total_session_count }})</h2>

        {% if all_sessions %}
        <div class="table-container">
            <table class="books-table">
                <tbody>
                    {% for session in all_sessions %}
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                {% if session.cover_url %}
                                <img src="{{ session.cover_url }}" alt="{{ session.title }}" style="width: 40px; height: 60px; object-fit: cover; border-radius: 4px;">
                                {% else %}
                                <div class="table-cover-placeholder" style="width: 40px; height: 60px; font-size: 24px;">üìï</div>
                                {% endif %}
                                <div>
                                    <strong>{{ session.title }}</strong><br>
                                    <span class="text-muted">by {{ session.author }}</span>
                                </div>
                            </div>
                        </td>
                        <td>{{ session.session_date }}</td>
                        <td>
                            {% set hours = (session.duration_seconds // 3600) %}
                            {% set minutes = ((session.duration_seconds % 3600) // 60) %}
                            {% if hours > 0 %}{{ hours }}h {% endif %}{{ minutes }}m
                        </td>
                        <td>{{ session.pages_read }}</td>
                        <td>{{ session.start_page }} ‚Üí {{ session.end_page }}</td>
                        <td class="actions-cell">
                            <form method="post" action="/sessions/delete/{{ session.id }}" style="display: inline;" onsubmit="return confirm('Delete this session?')">
                                <input type="hidden" name="book_id" value="{{ book.id }}">
                                <button type="submit" class="btn-icon btn-danger" title="Delete">üóëÔ∏è</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages_pagination > 1 %}
        <div class="pagination">
            <div class="pagination-info">
                Page {{ current_page }} of {{ total_pages_pagination }}
            </div>
            <div class="pagination-controls">
                {% if current_page > 1 %}
                <a href="/sessions/{{ book.id }}?week_start={{ week_start }}&page={{ current_page - 1 }}&limit={{ limit }}" class="btn btn-secondary">Previous</a>
                {% endif %}

                {% if current_page < total_pages_pagination %}
                <a href="/sessions/{{ book.id }}?week_start={{ week_start }}&page={{ current_page + 1 }}&limit={{ limit }}" class="btn btn-secondary">Next</a>
                {% endif %}
            </div>
            <div class="pagination-limit">
                <label>Show:</label>
                <select onchange="window.location.href='/sessions/{{ book.id }}?week_start={{ week_start }}&page=1&limit=' + this.value">
                    <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                    <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
                </select>
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="empty-state">
            <p>üì≠ No reading sessions recorded yet</p>
            <p class="text-muted">Start a timer session from the tracker page!</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    {% if weekly_sessions %}
    // Prepare data for the week (Sunday to Saturday)
    const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    const weeklyData = {{ weekly_sessions | tojson }};

    // Aggregate by day
    const dayData = {};
    daysOfWeek.forEach(day => {
        dayData[day] = { pages: 0, minutes: 0, hours: 0 };
    });

    weeklyData.forEach(session => {
        const date = new Date(session.session_date);
        const dayName = daysOfWeek[date.getDay()];
        const durationMinutes = Math.round(session.duration_seconds / 60);
        const pagesPerHour = session.duration_seconds > 0 ? (session.pages_read / session.duration_seconds) * 3600 : 0;

        dayData[dayName].pages += session.pages_read;
        dayData[dayName].minutes += durationMinutes;
        dayData[dayName].hours = pagesPerHour; // Will be recalculated
    });

    // Calculate pages per hour for each day
    const pagesPerHour = daysOfWeek.map(day => {
        if (dayData[day].minutes > 0) {
            return (dayData[day].pages / dayData[day].minutes) * 60;
        }
        return 0;
    });

    const minutesPerDay = daysOfWeek.map(day => dayData[day].minutes);
    const pagesPerDay = daysOfWeek.map(day => dayData[day].pages);

    // Minutes bar chart (trace1 - BARS FIRST)
    const trace1 = {
        x: daysOfWeek,
        y: minutesPerDay,
        name: 'Minutes',
        type: 'bar',
        marker: {
            color: '#447595',
            line: { color: '#34596d', width: 1 }
        },
        hoverlabel: {
            bgcolor: '#252526',
            font: { color: '#e5e7eb' }
        }
    };

    // Pages read line chart (trace2 - LINE SECOND)
    const trace2 = {
        x: daysOfWeek,
        y: pagesPerDay,
        name: 'Pages Read',
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#6bcc70', width: 3 },
        marker: { size: 8 },
        yaxis: 'y2',
        hoverlabel: {
            bgcolor: '#252526',
            font: { color: '#e5e7eb' }
        }
    };

    // Pages per hour line chart (trace3 - LINE THIRD)
    const trace3 = {
        x: daysOfWeek,
        y: pagesPerHour,
        name: 'Pages/Hour',
        type: 'scatter',
        mode: 'lines+markers',
        line: { color: '#ce736c', width: 3 },
        marker: { size: 8 },
        yaxis: 'y2',
        hoverlabel: {
            bgcolor: '#252526',
            font: { color: '#e5e7eb' }
        }
    };

    const layout = {
        paper_bgcolor: '#252526',
        plot_bgcolor: '#252526',
        font: {
            color: '#e5e7eb',
            family: 'Inter, sans-serif'
        },
        margin: { t: 30, r: 80, b: 50, l: 60 },
        yaxis: {
            title: 'Minutes',
            gridcolor: '#2c2c2d',
            linecolor: '#2c2c2d'
        },
        yaxis2: {
            title: 'Pages Read / Pages per Hour',
            overlaying: 'y',
            side: 'right',
            gridcolor: '#2c2c2d',
            linecolor: '#2c2c2d'
        },
        hovermode: 'x unified',
        showlegend: true,
        legend: {
            x: 0.5,
            y: 1.1,
            xanchor: 'center',
            orientation: 'h',
            bgcolor: '#252526',
            font: { color: '#e5e7eb' }
        }
    };

    const config = {
        displayModeBar: false,
        responsive: true
    };

    // BAR TRACE FIRST, THEN BOTH LINE TRACES
    Plotly.newPlot('paceChart', [trace1, trace2, trace3], layout, config);
    {% endif %}
</script>
{% endblock %}